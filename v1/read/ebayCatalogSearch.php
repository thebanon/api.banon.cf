<?php
//$config = require '/home/mallzones/ebay/configuration.php';
$config = [
    'sandbox' => [
        'credentials' => [
            'devId' => '7497225b-7850-4133-bd9d-32f4a61e2880',
            'appId' => 'TimothyO-MallZone-SBX-b820bcb7d-e08be0ce',
            'certId' => 'YSBX-820bcb7d6b91-7534-44ef-8d15-1ec0',
        ],
        'authToken' => '',
        'oauthUserToken' => 'v^1.1#i^1#I^3#p^3#r^0#f^0#t^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',
        'ruName' => 'testuser_mallzones'
    ],
    'production' => [
        'credentials' => [
            'devId' => '7497225b-7850-4133-bd9d-32f4a61e2880',
            'appId' => 'TimothyO-MallZone-PRD-f93587284-f6b3c618',
            'certId' => 'PRD-93587284d65c-30fe-4bac-b3f6-950a',
        ],
        'authToken' => 'YOUR_PRODUCTION_USER_TOKEN_APPLICATION_KEY',
        'oauthUserToken' => 'YOUR_PRODUCTION_OAUTH_USER_TOKEN',
        'ruName' => 'YOUR_PRODUCTION_RUNAME'
    ]
];
$env1 = $config['production'];
$env2 = $config['sandbox'];
$env = $env1;
$appId = $env2['credentials']['appId'];
$certId = $env2['credentials']['certId'];
$devId = $env2['credentials']['devId'];
$ruName = $env2['ruName'];
$data['credentials'] = $credentials = ['appId' => $appId, 'certId' => $certId, 'devId' => $devId];
$data['SESSION'] = $_SESSION;
//if(!$_SESSION['ebay']['access_token']) {
  $url = 'https://api.'.($env == $env2 ? 'sandbox.' : 'sandbox.').'ebay.com/identity/v1/oauth2/token';
  $headers = ['Content-Type:application/x-www-form-urlencoded', 'Authorization:Basic '.base64_encode($appId.':'.$certId)];
  $scopes = implode('%20', ['https://api.ebay.com/oauth/api_scope/commerce.catalog.readonly']);
  $body = http_build_query(['grant_type' => 'client_credentials', 'scope' => $scopes]);
  $curl = curl_init();
  curl_setopt_array($curl, array(
    CURLOPT_URL            => $url,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST  => 'POST',
    CURLOPT_POSTFIELDS     => $body,
    CURLOPT_HTTPHEADER     => $headers
  ));
  //$data['curl'] = curlRequest($url);
  //$data['response'] = $response = json_decode(curl_exec($curl));
  $_SESSION['ebay']['access_token'] = $response->access_token;
  //$err = curl_error($curl); curl_close($curl);
//}
$data['oauthToken'] = $oAuthToken = $_SESSION['ebay']['access_token'];

$url = 'https://api.'.($env == $env2 ? 'sandbox.' : '').'ebay.com/buy/browse/v1/item_summary/search?'.http_build_query(['q' => urlencode($vars['q']), 'limit' => 60]);
$headers = ['Authorization:Bearer '.$oAuthToken, 'Accept:application/json', 'Content-Type:application/json'];
//X-EBAY-C-ENDUSERCTX:affiliateCampaignId=<ePNCampaignId>,affiliateReferenceId=<referenceId>
$curl = curl_init();
curl_setopt_array($curl, array(CURLOPT_URL => $url, CURLOPT_RETURNTRANSFER => true, CURLOPT_CUSTOMREQUEST  => 'GET', CURLOPT_HTTPHEADER => $headers));
$result = json_decode(curl_exec($curl));
$itemSummaries = $result->itemSummaries;
if($result->errors[0]->errorId) {  
  $url = 'https://api.'.($env == $env2 ? 'sandbox.' : '').'ebay.com/identity/v1/oauth2/token';
  $headers = [
    'Content-Type:application/x-www-form-urlencoded',
    'Authorization:Basic '.base64_encode($appId.':'.$certId),
  ];
  $scopes = implode('%20', ['https://api.ebay.com/oauth/api_scope', 'https://api.ebay.com/oauth/api_scope/commerce.catalog.readonly']); //
  $body = http_build_query([
      'grant_type'   => 'client_credentials',
      'scope'        => $scopes
  ]);
  $curl = curl_init();
  curl_setopt_array($curl, array(
    CURLOPT_URL            => $url,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST  => 'POST',
    CURLOPT_POSTFIELDS     => $body,
    CURLOPT_HTTPHEADER     => $headers
  ));
  $response = json_decode(curl_exec($curl));
  $_SESSION['ebay']['access_token'] = $response->access_token;
  $data['err'] = curl_error($curl);
  curl_close($curl);
  //header("Refresh:0");
}
//$html .= '<div id=\'item-queue\' class=\'absolute overflow-x\' data-proc style=\'top:0;left:0;right:0;padding: 86px 0 0; height: calc(100% - 86px);\'>';

	//$html .= '<div id=\'item-cloud\' class=\'mda relative\' style=\'padding: 50px 0;\'>';    

  //$html .= '<div class=\'Lato\'>Web Results</div>';
  //$html .= '<div style=\'padding: 12px 5px; line-height: 13px; font-size: 11px; text-align: right;\'>'.'<div class=\'LatoLight bolder\'>Over '.count($result->itemSummaries).' search results</div>'.'</div>';   
  //$html .= '<div class=\'LatoLight bolder\'>Over '.$result['requestsLeft'].' requests available</div>'.'</div>';
  //$html .= $url.'<br><pre><code>'.print_r($result['items'],true).'"</code></pre>';  
  
$html .= '<div class=\'mda relative\' style=\'border-top-left-radius: 10px; border-top-right-radius: 10px; margin: 0 0 0;\'>';
  $html .= print_r($result, true);
  if(count($itemSummaries)>0) { 
    //$html .= '<script>alert("'.count($result['posts']).'");</script>';
    $webhose = $result; $news='';    
    $html .= '<div class=\'block\' data-style=\'ListFormat\'>';
    $html .= '<div class=\'media\'>';
    foreach($itemSummaries as $key=>$post) {    
      //$html .= print_r($post, true);
      $imageUrl = $post->image->imageUrl;
      $itemId = explode('|', $post->itemId)[1];      
      $title = $post->title;
      $msrp = $post->price->value;
      $epid = $post->epid;
      $html .= '<div class=\'event item format merch\' data-format=\'merch\''.($fvscnt>0 ? ' data-dbs' : null).' data-id=\''.$itemId.'\'>';
        $html .= '<div class=\'itm relative bkgcvr\' data-id=\''.$item.'\' data-img=\'url("'.$imageUrl.'")\'></div>';
        $html .= '<div>';
          $html .= '<div class=\'item-Title relative\'>'.$title.'</div>';
          $html .= '<div class=\'item-Pricing Lato bolder\' data-swp>';
            if($msrp>0) { $html .= '<div class=\'inline LatoRegular'.($salePrice ? ' line-through' : null).'\' style=\''.($salePrice>0 ? 'margin:0 0 0 10px; text-decoration: line-through;' : 'color:#ff3b30;').'\'>'.$msrp.'</div>'; }
          $html .= '</div>';
      
          $html .= '<div class=\'bolder left relative\' style=\'justify-content: space-around; z-index: 123456789; padding: 0 5px;line-height: 36px;height: 36px;font-size: 11px;width: calc(100% - 10px); margin: auto;\' data-swp>';

            $html .= '<div data-swp style=\'margin: 0 0 0 0;\'><div class=\'relative\' style=\'width: 20px; height: 36px; padding: 0 0px; border-radius: 30px;\'>';
              $html .= '<icon class=\'absolute bkgctn\' style=\'top: 1px; left: -1px; filter: invert(0); width: 14px; height: 14px; margin: 11px 5px 0 0; background-image: url(/assets/pencil.svg);\'></icon>';
              //$html .= '<icon class=\'absolute bkgctn\' style=\'top: 0; left: 0px; filter: invert(1); width: 14px; height: 14px; margin: 11px 5px 0 0; background-image: url(/assets/pencil.svg);\'></icon>';
            $html .= '</div><div style=\'margin: 0 0px 0 0;\'>Edit</div></div>';

            $html .= '<div data-swp style=\'margin: 0 0 0 20px;\'><div class=\'relative\' style=\'width: 20px; height: 36px; padding: 0 0px; border-radius: 30px;\'>';
              $html .= '<icon class=\'absolute bkgctn\' style=\'top: 1px; left: -1px; filter: invert(0); width: 14px; height: 14px; margin: 11px 5px 0 0; background-image: url(/assets/view.svg);\'></icon>';
              //$html .= '<icon class=\'absolute bkgctn\' style=\'top: 0; left: 0px; filter: invert(1); width: 14px; height: 14px; margin: 11px 5px 0 0; background-image: url(/assets/copy.svg);\'></icon>';
            $html .= '</div><div style=\'margin: 0 0px 0 0;\'>View</div></div>';

            $html .= '<div data-swp style=\'margin: 0 0 0 20px;\'><div class=\'relative\' style=\'width: 20px; height: 36px; padding: 0 0px; border-radius: 30px;\'>';
              $html .= '<icon class=\'absolute bkgctn\' style=\'top: 1px; left: -1px; filter: invert(0); width: 14px; height: 14px; margin: 11px 5px 0 0; background-image: url(/assets/delete.svg);\'></icon>';
              //$html .= '<icon class=\'absolute bkgctn\' style=\'top: 0; left: 0px; filter: invert(1); width: 14px; height: 14px; margin: 11px 5px 0 0; background-image: url(/assets/delete.svg);\'></icon>';
            $html .= '</div><div style=\'margin: 0 0px 0 0;\'>Delete</div></div>';

          $html .= '</div>';
      
        $html .= '</div>';      
      $html .= '</div>';


    }
    $html .= '</div></div>';
  }

  //else {
    //$html .= '<div>"API Error: '.$url.'<br>'.print_r($result,true).'"</div>';
  //}
  
	//$html .= '</div>';

	//$html .= '<div class=\'loadmore\' data-app=\''.$thisappid.'\' data-kwd=\''.$Keywords.'\' data-nde=\''.$BrowseNodeId.'\' data-idx=\''.$SearchIndex.'\' data-pgs=\'1\' style=\'display:none;\'>Load More</div>';

$html .= '</div>';  
$data['html'] = $html;

//$data['curl'] = $get_data = callAPI('GET', 'https://mockapi.free.beeceptor.com/', false);

function curlRequest($url) {
  try {
      $ch = curl_init();
      if($ch === false) { throw new Exception('failed to initialize'); }
      curl_setopt($ch, CURLOPT_URL, $url);
      curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
      $content = curl_exec($ch);
      if ($content === false) {
          throw new Exception(curl_error($ch), curl_errno($ch));
      } else {
        return $data['result'] = $content;
      }
      curl_close($ch);
  } catch(Exception $e) {
      trigger_error(sprintf(
          'Curl failed with error #%d: %s',
          $e->getCode(), $e->getMessage()),
          E_USER_ERROR);
      $data['error']['message'] = curl_error($ch);
      $data['error']['code'] = curl_errno($ch);
  }
}
?>